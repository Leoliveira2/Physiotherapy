import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { Calendar, Save, User, Activity, AlertTriangle, Clock, Search, CheckCircle, XCircle, Home, UserPlus, List, Eye, FileText, Users } from 'lucide-react';

// --- HOOK CUSTOMIZADO PARA A LÓGICA DE NEGÓCIO ---
const useFisioterapiaApp = () => {
  const [pacientes, setPacientes] = useState({});
  const [loading, setLoading] = useState(false);

  // Carregar dados na inicialização
  useEffect(() => {
    try {
      const dadosSalvos = localStorage.getItem('fisioterapia_pacientes');
      if (dadosSalvos) {
        setPacientes(JSON.parse(dadosSalvos));
      }
    } catch (error) {
      console.error('Erro ao carregar dados:', error);
      // Fallback em caso de erro no localStorage
      setPacientes({});
    }
  }, []);

  // Função para salvar dados no storage
  const salvarDados = useCallback((novosDados) => {
    try {
      localStorage.setItem('fisioterapia_pacientes', JSON.stringify(novosDados));
    } catch (error) {
      console.error('Erro ao salvar dados:', error);
      alert('Erro ao salvar dados. Verifique o espaço de armazenamento do navegador.');
    }
  }, []);

  // Criar novo paciente
  const criarNovoPaciente = useCallback((quarto, dadosPaciente) => {
    setLoading(true);
    const novoPaciente = {
      id: Date.now(),
      quarto: quarto,
      ...dadosPaciente,
      dataInternacao: new Date().toISOString().split('T')[0],
      altaMedica: false,
      avaliacoes: []
    };
    
    const novosPacientes = { ...pacientes, [quarto]: novoPaciente };
    setPacientes(novosPacientes);
    salvarDados(novosPacientes);
    setLoading(false);
    
    return novoPaciente;
  }, [pacientes, salvarDados]);

  // Salvar avaliação
  const salvarAvaliacao = useCallback((pacienteAtual, dadosForm, pontuacao) => {
    const novaAvaliacao = {
      id: Date.now(),
      ...dadosForm,
      pontuacaoTotal: pontuacao,
      dataRegistro: new Date().toISOString()
    };
    
    const pacienteAtualizado = {
      ...pacienteAtual,
      avaliacoes: [...(pacienteAtual.avaliacoes || []), novaAvaliacao]
    };
    
    const novosPacientes = {
      ...pacientes,
      [pacienteAtual.quarto]: pacienteAtualizado
    };
    
    setPacientes(novosPacientes);
    salvarDados(novosPacientes);
    
    return pacienteAtualizado;
  }, [pacientes, salvarDados]);

  // Dar alta médica
  const darAltaMedica = useCallback((pacienteAtual) => {
    const pacienteComAlta = {
      ...pacienteAtual,
      altaMedica: true,
      dataAlta: new Date().toISOString().split('T')[0]
    };
    
    const novosPacientes = {
      ...pacientes,
      [pacienteAtual.quarto]: pacienteComAlta
    };
    
    setPacientes(novosPacientes);
    salvarDados(novosPacientes);
  }, [pacientes, salvarDados]);

  return {
    pacientes,
    loading,
    criarNovoPaciente,
    salvarAvaliacao,
    darAltaMedica
  };
};

// --- COMPONENTE GENÉRICO PARA BOTÕES DE SELEÇÃO ---
const ToggleButton = ({ label, icon, value, selectedValue, onSelect, valueToMatch, color }) => (
  <button
    onClick={() => onSelect(value)}
    className={`flex-1 flex items-center justify-center gap-2 py-2 px-4 rounded-lg font-medium transition-all ${
      selectedValue === valueToMatch
        ? `${color} text-white shadow-lg transform scale-105`
        : 'bg-white text-gray-600 border border-gray-300 hover:bg-gray-50'
    }`}
  >
    {icon}
    {label}
  </button>
);

// --- COMPONENTE PRINCIPAL ---
const FisioterapiaApp = () => {
  const { pacientes, loading, criarNovoPaciente, salvarAvaliacao, darAltaMedica } = useFisioterapiaApp();

  const [quartoSelecionado, setQuartoSelecionado] = useState('');
  const [pacienteAtual, setPacienteAtual] = useState(null);
  const [modoNovoRegistro, setModoNovoRegistro] = useState(false);
  const [telaAtiva, setTelaAtiva] = useState('principal');

  // Estado do formulário de avaliação
  const [dadosForm, setDadosForm] = useState({
    dataAvaliacao: new Date().toISOString().split('T')[0],
    horaAvaliacao: new Date().toTimeString().split(' ')[0].slice(0, 5),
    escalaMobilidade: '',
    ventilacao: '',
    observacoes: '',
    complexidade: '',
    restricaoLeito: 'Não',
    altoRiscoQueda: 'Não',
    dispositivos1a2: 'Não',
    dispositivos3mais: 'Não',
    social: 'Não',
    mobilizacaoDevice: 'Não',
    necessidadeO2: 'Não'
  });

  const [pontuacao, setPontuacao] = useState(0);

  // Lógica de busca de paciente
  const buscarPacientePorQuarto = useCallback((numeroQuarto) => {
    if (!numeroQuarto) {
      alert('Digite um número de quarto');
      return;
    }
    const paciente = pacientes[numeroQuarto];
    if (paciente && !paciente.altaMedica) {
      setPacienteAtual(paciente);
      setModoNovoRegistro(false);
    } else {
      setPacienteAtual(null);
      setModoNovoRegistro(true);
    }
  }, [pacientes]);

  // Lógica para calcular a pontuação de forma mais otimizada
  useEffect(() => {
    let total = 0;
    const { complexidade, ...criteriosBool } = dadosForm;

    // Pontuação de complexidade
    const complexidadePontos = { 'Baixa': 1, 'Média': 2, 'Alta': 3 };
    total += complexidadePontos[complexidade] || 0;

    // Pontuação dos critérios booleanos
    const criteriosPontos = {
      restricaoLeito: 1, altoRiscoQueda: 1, dispositivos1a2: 2,
      dispositivos3mais: 3, social: 3, mobilizacaoDevice: 4,
      necessidadeO2: 5
    };

    Object.keys(criteriosBool).forEach(key => {
      if (criteriosBool[key] === 'Sim') {
        total += criteriosPontos[key] || 0;
      }
    });

    setPontuacao(total);
  }, [dadosForm]);

  const handleSalvarAvaliacao = () => {
    if (!pacienteAtual) {
      alert('Erro: Nenhum paciente selecionado');
      return;
    }
    
    const pacienteAtualizado = salvarAvaliacao(pacienteAtual, dadosForm, pontuacao);
    setPacienteAtual(pacienteAtualizado);
    
    // Resetar formulário
    setDadosForm({
      ...dadosForm,
      escalaMobilidade: '',
      ventilacao: '',
      observacoes: '',
      complexidade: '',
      restricaoLeito: 'Não',
      altoRiscoQueda: 'Não',
      dispositivos1a2: 'Não',
      dispositivos3mais: 'Não',
      social: 'Não',
      mobilizacaoDevice: 'Não',
      necessidadeO2: 'Não'
    });
    
    alert('Avaliação salva com sucesso!');
  };

  const handleDarAlta = () => {
    if (!pacienteAtual) return;
    darAltaMedica(pacienteAtual);
    setPacienteAtual(null);
    setModoNovoRegistro(true);
    alert('Alta médica registrada com sucesso!');
  };

  const getComplexidadeColor = useMemo(() => {
    switch (dadosForm.complexidade) {
      case 'Baixa': return 'text-green-600 bg-green-50 border-green-200';
      case 'Média': return 'text-yellow-600 bg-yellow-50 border-yellow-200';
      case 'Alta': return 'text-red-600 bg-red-50 border-red-200';
      default: return 'text-gray-600 bg-gray-50 border-gray-200';
    }
  }, [dadosForm.complexidade]);

  // Componentes de visualização (mantidos os mesmos)
  const renderContent = () => {
    switch(telaAtiva) {
      case 'principal':
        return (
          <>
            {/* Formulário de Novo Paciente */}
            {modoNovoRegistro && quartoSelecionado && (
              <NovoPacienteForm 
                quarto={quartoSelecionado} 
                onCriarPaciente={criarNovoPaciente}
                loading={loading}
              />
            )}
            
            {/* Formulário de Avaliação e Critérios */}
            {pacienteAtual && !pacienteAtual.altaMedica && (
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2 space-y-6">
                  <AvaliacaoForm 
                    dadosForm={dadosForm}
                    handleInputChange={value => setDadosForm(prev => ({ ...prev, ...value }))}
                    getComplexidadeColor={getComplexidadeColor}
                  />
                </div>
                <div className="space-y-6">
                  <CriteriosAvaliacao 
                    dadosForm={dadosForm}
                    handleInputChange={value => setDadosForm(prev => ({ ...prev, ...value }))}
                    pontuacao={pontuacao}
                    onSalvar={handleSalvarAvaliacao}
                  />
                </div>
              </div>
            )}
            
            {/* Histórico de Avaliações */}
            {pacienteAtual && pacienteAtual.avaliacoes?.length > 0 && (
              <HistoricoAvaliacoes avaliacoes={pacienteAtual.avaliacoes} />
            )}
          </>
        );
      case 'consulta':
        return <TelaConsulta pacientes={pacientes} onVoltar={() => setTelaAtiva('principal')} onVisualizarPaciente={setQuartoSelecionado} />;
      default:
        return null;
    }
  };

  return (
    <div className="max-w-6xl mx-auto p-6 bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
      {/* Header com navegação */}
      <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
        <div className="flex justify-between items-center">
          <div>
            <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-3">
              <Activity className="text-blue-600" size={36} />
              Sistema de Registro de Pacientes - Fisioterapia
            </h1>
            <p className="text-gray-600 mt-2">Gestão inteligente por quarto com histórico completo</p>
          </div>
          <button
            onClick={() => setTelaAtiva('consulta')}
            className="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition-colors"
          >
            <Users size={20} />
            Consultar Registros
          </button>
        </div>
      </div>

      {/* Busca por Quarto */}
      <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
        <div className="flex items-center gap-4">
          <div className="flex-1">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              Número do Quarto
            </label>
            <div className="flex gap-3">
              <input
                type="text"
                value={quartoSelecionado}
                onChange={(e) => setQuartoSelecionado(e.target.value)}
                className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg"
                placeholder="Ex: 520"
              />
              <button
                onClick={() => buscarPacientePorQuarto(quartoSelecionado)}
                className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition-colors"
              >
                <Search size={20} />
                Buscar
              </button>
            </div>
          </div>
        </div>

        {/* Status do Quarto */}
        {quartoSelecionado && (
          <div className="mt-4">
            {pacienteAtual && !pacienteAtual.altaMedica ? (
              <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="text-lg font-semibold text-green-800">{pacienteAtual.nomeCompleto}</h3>
                    <p className="text-green-600">Internado desde: {new Date(pacienteAtual.dataInternacao).toLocaleDateString('pt-BR')}</p>
                    <p className="text-green-600">Avaliações: {pacienteAtual.avaliacoes?.length || 0}</p>
                  </div>
                  <button
                    onClick={handleDarAlta}
                    className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors"
                  >
                    <Home size={16} />
                    Alta Médica
                  </button>
                </div>
              </div>
            ) : modoNovoRegistro ? (
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div className="flex items-center gap-2">
                  <UserPlus className="text-blue-600" size={20} />
                  <span className="text-blue-800 font-medium">Quarto disponível - Cadastrar novo paciente</span>
                </div>
              </div>
            ) : (
              <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                <span className="text-gray-600">Digite um número de quarto para continuar</span>
              </div>
            )}
          </div>
        )}
      </div>

      {renderContent()}
    </div>
  );
};

// --- COMPONENTES AUXILIARES (PONTUAÇÃO E CRITÉRIOS REUSADOS) ---
const CriteriosAvaliacao = ({ dadosForm, handleInputChange, pontuacao, onSalvar }) => {
  const criterios = [
    { key: 'restricaoLeito', label: 'Restrito ao Leito', icon: '🛏️', pontos: 1 },
    { key: 'altoRiscoQueda', label: 'Alto Risco de Queda', icon: '⚠️', pontos: 1 },
    { key: 'dispositivos1a2', label: '1 a 2 Dispositivos', icon: '🔌', pontos: 2 },
    { key: 'dispositivos3mais', label: '3+ Dispositivos', icon: '🔌', pontos: 3 },
    { key: 'social', label: 'Questão Social', icon: '👥', pontos: 3 },
    { key: 'mobilizacaoDevice', label: 'Mobilização c/ Device', icon: '🦽', pontos: 4 },
    { key: 'necessidadeO2', label: 'Necessidade de O₂/DVA', icon: '💨', pontos: 5 }
  ];

  const handleToggle = useCallback((key, value) => {
    handleInputChange({ [key]: value });
  }, [handleInputChange]);

  return (
    <div className="space-y-6">
      {/* Critérios */}
      <div className="bg-white rounded-xl shadow-lg p-6">
        <h2 className="text-xl font-semibold text-gray-900 mb-6 flex items-center gap-2">
          <AlertTriangle className="text-yellow-600" />
          Critérios de Avaliação
        </h2>

        <div className="space-y-4">
          {criterios.map((criterio) => (
            <div key={criterio.key} className="bg-gradient-to-r from-gray-50 to-gray-100 p-4 rounded-lg">
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center gap-2">
                  <span className="text-2xl">{criterio.icon}</span>
                  <span className="font-medium text-gray-800">{criterio.label}</span>
                </div>
                <span className="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full">
                  +{criterio.pontos} pts
                </span>
              </div>
              
              <div className="flex gap-3">
                <ToggleButton 
                  label="Sim"
                  icon={<CheckCircle size={16} />}
                  value="Sim"
                  selectedValue={dadosForm[criterio.key]}
                  onSelect={(value) => handleToggle(criterio.key, value)}
                  valueToMatch="Sim"
                  color="bg-green-500"
                />
                <ToggleButton 
                  label="Não"
                  icon={<XCircle size={16} />}
                  value="Não"
                  selectedValue={dadosForm[criterio.key]}
                  onSelect={(value) => handleToggle(criterio.key, value)}
                  valueToMatch="Não"
                  color="bg-red-500"
                />
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Pontuação Total */}
      <div className="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-lg p-6 text-white text-center">
        <h3 className="text-xl font-semibold mb-4">Pontuação Total</h3>
        <div className="text-6xl font-bold mb-2">
          {pontuacao}
        </div>
        <div className="bg-white bg-opacity-20 rounded-lg p-3">
          <p className="font-medium">
            {pontuacao >= 15 ? '🔴 Alta Complexidade' : 
             pontuacao >= 10 ? '🟡 Média Complexidade' : 
             '🟢 Baixa Complexidade'}
          </p>
        </div>
      </div>

      {/* Botão Salvar */}
      <button
        onClick={onSalvar}
        className="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-4 px-6 rounded-xl transition-all shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center gap-2"
      >
        <Save size={20} />
        Salvar Avaliação
      </button>
    </div>
  );
};

// ... O resto dos componentes (NovoPacienteForm, AvaliacaoForm, HistoricoAvaliacoes, TelaConsulta) permanecem os mesmos ou com pequenas adaptações.
// No AvaliacaoForm, a prop handleInputChange agora recebe um objeto, então a chamada deve ser `handleInputChange({ [e.target.name]: e.target.value })`
// E nos inputs, o `name` deve ser adicionado: `<input name="dataAvaliacao" ... />`

export default FisioterapiaApp;
